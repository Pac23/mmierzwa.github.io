---
layout: post
title: SharePoint Taxonomies - Commiting large amount of data to the MMD service
date: '2012-10-02T11:08:00.000+02:00'
author: Marek Mierzwa
tags:
- term
- sharepoint
- sharepoint 2010
modified_time: '2012-10-02T11:08:11.714+02:00'
blogger_id: tag:blogger.com,1999:blog-2283486810269355053.post-3603881166395201090
blogger_orig_url: http://byteloom.blogspot.com/2012/10/sharepoint-taxonomies-commiting-large.html
---

Once again about the SharePoint 2010 taxonomy service.<br /><br />As I wrote in my previous posts, loading data into MMD service automatically can be quite a challenge. First, you must <a href="{{ site.baseurl }}{% post_url 2012-09-20-sharepoint-taxonomies-labels-with %}">remember about illegal characters in terms labels</a>. Second, you must <a href="{{ site.baseurl }}{% post_url 2012-09-28-sharepoint-taxonomies-struggling-with %}">trace duplicates across sibling nodes</a> in taxonomy trees. And this could not be the end of your problems especially if you plan to load some more data at one time.<br /><a name='more'></a><br />Since MMD service is transactional you must first perform the <a href="http://msdn.microsoft.com/en-us/library/microsoft.sharepoint.taxonomy.termstore.commitall.aspx" target="_blank">commit</a> operation in order to see your changes in MMD picker. From the programmatic point of view MMD service is a classic WCF service with http/https endpoints and <a href="http://msdn.microsoft.com/en-us/library/microsoft.sharepoint.taxonomy.taxonomysession.aspx" target="_blank">client proxy</a> which is used in daily SharePoint development.<br /><br />When you try to perform some more complex set of operations (like adding or removing large number of terms and term sets) in one transaction you may come across the following error: <br /><tt>An error occurred while receiving the HTTP response to http://hostname:32843/3d1e97ecf7074067957b8efdac3ae1ab/MetadataWebService.svc. This could be due to the service endpoint binding not using the HTTP protocol. This could also be due to an HTTP request context being aborted by the server (possibly due to the service shutting down). See server logs for more details.</tt><br />Here is a full error description:<br /><pre class="brush: text; gutter: false; collapse: true; toolbar: true;">System.ServiceModel.CommunicationException was caught<br />  Message=An error occurred while receiving the HTTP response to http://hostname:32843/3d1e97ecf7074067957b8efdac3ae1ab/MetadataWebService.svc. This could be due to the service endpoint binding not using the HTTP protocol. This could also be due to an HTTP request context being aborted by the server (possibly due to the service shutting down). See server logs for more details.<br />  Source=mscorlib<br />  StackTrace:<br />    Server stack trace: <br />       at System.ServiceModel.Channels.HttpChannelUtilities.ProcessGetResponseWebException(WebException webException, HttpWebRequest request, HttpAbortReason abortReason)<br />       at System.ServiceModel.Channels.HttpChannelFactory.HttpRequestChannel.HttpChannelRequest.WaitForReply(TimeSpan timeout)<br />       at System.ServiceModel.Channels.RequestChannel.Request(Message message, TimeSpan timeout)<br />       at System.ServiceModel.Channels.SecurityChannelFactory`1.SecurityRequestChannel.Request(Message message, TimeSpan timeout)<br />       at System.ServiceModel.Dispatcher.RequestChannelBinder.Request(Message message, TimeSpan timeout)<br />       at System.ServiceModel.Channels.ServiceChannel.Call(String action, Boolean oneway, ProxyOperationRuntime operation, Object[] ins, Object[] outs, TimeSpan timeout)<br />       at System.ServiceModel.Channels.ServiceChannelProxy.InvokeService(IMethodCallMessage methodCall, ProxyOperationRuntime operation)<br />       at System.ServiceModel.Channels.ServiceChannelProxy.Invoke(IMessage message)<br />    Exception rethrown at [0]: <br />       at System.Runtime.Remoting.Proxies.RealProxy.HandleReturnMessage(IMessage reqMsg, IMessage retMsg)<br />       at System.Runtime.Remoting.Proxies.RealProxy.PrivateInvoke(MessageData& msgData, Int32 type)<br />       at Microsoft.SharePoint.Taxonomy.Internal.IDataAccessReadWrite.Write(String data)<br />       at Microsoft.SharePoint.Taxonomy.Internal.TaxonomyProxyAccess.<>c__DisplayClass40.<Write>b__3f(IMetadataWebServiceApplication serviceApplication)<br />       at Microsoft.SharePoint.Taxonomy.MetadataWebServiceApplicationProxy.<>c__DisplayClass2c.<RunOnChannel>b__2b()<br />       at Microsoft.Office.Server.Security.SecurityContext.RunAsProcess(CodeToRunElevated secureCode)<br />       at Microsoft.SharePoint.Taxonomy.MetadataWebServiceApplicationProxy.<>c__DisplayClass2c.<RunOnChannel>b__2a()<br />       at Microsoft.Office.Server.Utilities.MonitoredScopeWrapper.RunWithMonitoredScope(Action code)<br />       at Microsoft.SharePoint.Taxonomy.MetadataWebServiceApplicationProxy.RunOnChannel(CodeToRun codeToRun, Double operationTimeoutFactor)<br />       at Microsoft.SharePoint.Taxonomy.MetadataWebServiceApplicationProxy.RunOnChannel(CodeToRun codeToRun)<br />       at Microsoft.SharePoint.Taxonomy.Internal.TaxonomyProxyAccess.Write(String data)<br />       at Microsoft.SharePoint.Taxonomy.Internal.DataAccessManager.Write(String data)<br />       at Microsoft.SharePoint.Taxonomy.Internal.Sandbox.CommitSandbox()<br />       at Microsoft.SharePoint.Taxonomy.TermStore.CommitAll()<br />       at ...<br /><br />  InnerException: System.Net.WebException<br />       Message=The underlying connection was closed: An unexpected error occurred on a receive.<br />       Source=System<br />       StackTrace:<br />            at System.Net.HttpWebRequest.GetResponse()<br />            at System.ServiceModel.Channels.HttpChannelFactory.HttpRequestChannel.HttpChannelRequest.WaitForReply(TimeSpan timeout)<br />       InnerException: System.IO.IOException<br />            Message=Unable to read data from the transport connection: An existing connection was forcibly closed by the remote host.<br />            Source=System<br />            StackTrace:<br />                 at System.Net.Sockets.NetworkStream.Read(Byte[] buffer, Int32 offset, Int32 size)<br />                 at System.Net.PooledStream.Read(Byte[] buffer, Int32 offset, Int32 size)<br />                 at System.Net.Connection.SyncRead(HttpWebRequest request, Boolean userRetrievedStream, Boolean probeRead)<br />            InnerException: System.Net.Sockets.SocketException<br />                 Message=An existing connection was forcibly closed by the remote host<br />                 Source=System<br />                 ErrorCode=10054<br />                 NativeErrorCode=10054<br />                 StackTrace:<br />                      at System.Net.Sockets.NetworkStream.Read(Byte[] buffer, Int32 offset, Int32 size)<br />                 InnerException: <br /></pre>The bottom exception of the stacktrace - <tt>System.Net.WebException (The underlying connection was closed: An unexpected error occurred on a receive)</tt> suggests that problem related with web application/IIS configuration rather than MMS service itself. <a href="http://code2life.blogspot.com" target="_blank">Andreas Cieslik</a> already found the solution for this and <a href="http://code2life.blogspot.com/2011/10/recently-i-tried-to-publish-custom.html" target="_blank">posted on his blog</a>. In short - you must increase the default request restrictions in services web.config file.<br /><br />When changed this the <tt>System.ServiceModel.CommunicationException</tt> disappeared but I've got another error:<br /><tt>System.TimeoutException was caught<br />  Message=The request channel timed out while waiting for a reply after 00:00:29.9570296. Increase the timeout value passed to the call to Request or increase the SendTimeout value on the Binding. The time allotted to this operation may have been a portion of a longer timeout.</tt><br />and the full error description:<br /><pre class="brush: text; gutter: false; collapse: true; toolbar: true;">System.TimeoutException was caught<br />  Message=The request channel timed out while waiting for a reply after 00:00:29.9570296. Increase the timeout value passed to the call to Request or increase the SendTimeout value on the Binding. The time allotted to this operation may have been a portion of a longer timeout.<br />  Source=mscorlib<br />  StackTrace:<br />    Server stack trace: <br />       at System.ServiceModel.Channels.RequestChannel.Request(Message message, TimeSpan timeout)<br />       at System.ServiceModel.Channels.SecurityChannelFactory`1.SecurityRequestChannel.Request(Message message, TimeSpan timeout)<br />       at System.ServiceModel.Dispatcher.RequestChannelBinder.Request(Message message, TimeSpan timeout)<br />       at System.ServiceModel.Channels.ServiceChannel.Call(String action, Boolean oneway, ProxyOperationRuntime operation, Object[] ins, Object[] outs, TimeSpan timeout)<br />       at System.ServiceModel.Channels.ServiceChannelProxy.InvokeService(IMethodCallMessage methodCall, ProxyOperationRuntime operation)<br />       at System.ServiceModel.Channels.ServiceChannelProxy.Invoke(IMessage message)<br />    Exception rethrown at [0]: <br />       at System.Runtime.Remoting.Proxies.RealProxy.HandleReturnMessage(IMessage reqMsg, IMessage retMsg)<br />       at System.Runtime.Remoting.Proxies.RealProxy.PrivateInvoke(MessageData& msgData, Int32 type)<br />       at Microsoft.SharePoint.Taxonomy.Internal.IDataAccessReadWrite.Write(String data)<br />       at Microsoft.SharePoint.Taxonomy.Internal.TaxonomyProxyAccess.<>c__DisplayClass40.<Write>b__3f(IMetadataWebServiceApplication serviceApplication)<br />       at Microsoft.SharePoint.Taxonomy.MetadataWebServiceApplicationProxy.<>c__DisplayClass2c.<RunOnChannel>b__2b()<br />       at Microsoft.Office.Server.Security.SecurityContext.RunAsProcess(CodeToRunElevated secureCode)<br />       at Microsoft.SharePoint.Taxonomy.MetadataWebServiceApplicationProxy.<>c__DisplayClass2c.<RunOnChannel>b__2a()<br />       at Microsoft.Office.Server.Utilities.MonitoredScopeWrapper.RunWithMonitoredScope(Action code)<br />       at Microsoft.SharePoint.Taxonomy.MetadataWebServiceApplicationProxy.RunOnChannel(CodeToRun codeToRun, Double operationTimeoutFactor)<br />       at Microsoft.SharePoint.Taxonomy.MetadataWebServiceApplicationProxy.RunOnChannel(CodeToRun codeToRun)<br />       at Microsoft.SharePoint.Taxonomy.Internal.TaxonomyProxyAccess.Write(String data)<br />       at Microsoft.SharePoint.Taxonomy.Internal.DataAccessManager.Write(String data)<br />       at Microsoft.SharePoint.Taxonomy.Internal.Sandbox.CommitSandbox()<br />       at Microsoft.SharePoint.Taxonomy.TermStore.CommitAll()<br />       at ABB.Library.Publishing.SharePoint.CategoryImport.ClassificationProvider.CategoryTermStoreAdapter.Commit() in C:\work\Dev\07SharePoint\01Impl\ABB.Library.Publishing.SharePoint\ABB.Library.Publishing.SharePoint.CategoryImport\ClassificationProvider\CategoryTermStoreAdapter.cs:line 152<br />       at ABB.Library.Publishing.SharePoint.CategoryImport.ImportProcess.Import() in C:\work\Dev\07SharePoint\01Impl\ABB.Library.Publishing.SharePoint\ABB.Library.Publishing.SharePoint.CategoryImport\ImportProcess.cs:line 49<br />  InnerException: System.TimeoutException<br />       Message=The HTTP request to 'http://hostname:32843/3d1e97ecf7074067957b8efdac3ae1ab/MetadataWebService.svc' has exceeded the allotted timeout of 00:00:30. The time allotted to this operation may have been a portion of a longer timeout.<br />       Source=System.ServiceModel<br />       StackTrace:<br />            at System.ServiceModel.Channels.HttpChannelUtilities.ProcessGetResponseWebException(WebException webException, HttpWebRequest request, HttpAbortReason abortReason)<br />            at System.ServiceModel.Channels.HttpChannelFactory.HttpRequestChannel.HttpChannelRequest.WaitForReply(TimeSpan timeout)<br />            at System.ServiceModel.Channels.RequestChannel.Request(Message message, TimeSpan timeout)<br />       InnerException: System.Net.WebException<br />            Message=The operation has timed out<br />            Source=System<br />            StackTrace:<br />                 at System.Net.HttpWebRequest.GetResponse()<br />                 at System.ServiceModel.Channels.HttpChannelFactory.HttpRequestChannel.HttpChannelRequest.WaitForReply(TimeSpan timeout)<br />            InnerException:<br /></pre><br /><tt>sendTimeout</tt> is a strictly WCF thing, but unfortunately SharePoint taxonomy server side API does not provide any method for passing client side timeouts. You can do this only through %SharePointRoot%\WebClients\Metadata\client.config file:<br /><pre class="brush: xml; highlight: [21, 42];">&lt;?xml version="1.0" encoding="utf-8" ?&gt;<br />&lt;configuration&gt;<br />  &lt;system.serviceModel&gt;<br />    &lt;client&gt;<br />      &lt;endpoint<br />        name="http"<br />        contract="Microsoft.SharePoint.Taxonomy.IMetadataWebServiceApplication"<br />        binding="customBinding"<br />        bindingConfiguration="MetadataWebServiceHttpBinding" /&gt;<br />      &lt;endpoint<br />        name="https"<br />        contract="Microsoft.SharePoint.Taxonomy.IMetadataWebServiceApplication"<br />        binding="customBinding"<br />        bindingConfiguration="MetadataWebServiceHttpsBinding" /&gt;<br />    &lt;/client&gt;<br />    &lt;bindings&gt;<br />      &lt;customBinding&gt;<br />        &lt;binding<br />          name="MetadataWebServiceHttpBinding"<br />                 receiveTimeout="00:00:30"<br />                 sendTimeout="00:00:30"<br />                 openTimeout="00:00:30"<br />                 closeTimeout="00:00:30"&gt;<br />          &lt;security<br />            authenticationMode="IssuedTokenOverTransport"<br />            allowInsecureTransport="true" /&gt;<br />          &lt;binaryMessageEncoding&gt;<br />            &lt;readerQuotas<br />               maxStringContentLength="2147483647"<br />               maxArrayLength="2147483647"<br />               maxBytesPerRead="2147483647" /&gt;<br />          &lt;/binaryMessageEncoding&gt;<br />          &lt;httpTransport<br />            transferMode="StreamedResponse"<br />            maxReceivedMessageSize="2147483647"<br />            authenticationScheme="Anonymous"<br />            useDefaultWebProxy="false" /&gt;<br />        &lt;/binding&gt;<br />        &lt;binding<br />          name="MetadataWebServiceHttpsBinding"<br />                 receiveTimeout="00:00:30"<br />                 sendTimeout="00:00:30"<br />                 openTimeout="00:00:30"<br />                 closeTimeout="00:00:30"&gt;<br />          &lt;security<br />            authenticationMode="IssuedTokenOverTransport" /&gt;<br />          &lt;binaryMessageEncoding&gt;<br />            &lt;readerQuotas<br />              maxStringContentLength="2147483647"<br />              maxArrayLength="2147483647"<br />              maxBytesPerRead="2147483647" /&gt;<br />          &lt;/binaryMessageEncoding&gt;<br />          &lt;httpsTransport<br />            transferMode="StreamedResponse"<br />            maxReceivedMessageSize="2147483647"<br />            authenticationScheme="Anonymous"<br />            useDefaultWebProxy="false" /&gt;<br />        &lt;/binding&gt;<br />      &lt;/customBinding&gt;<br />    &lt;/bindings&gt;<br />  &lt;/system.serviceModel&gt;<br />  &lt;system.net&gt;<br />    &lt;connectionManagement&gt;<br />      &lt;add address="*" maxconnection="10000" /&gt;<br />    &lt;/connectionManagement&gt;<br />  &lt;/system.net&gt;<br />&lt;/configuration&gt;<br /></pre><br />The values that must be increased are <tt>sendTimeout</tt> for proper bindings (line 21 for http and 42 for https). In my case it must have been changed to 10 minutes.<br /><br />Please note that both settings - maximum request length for all SP web services and WCF settings for MMD service - are server wide and will affect the whole machine (or farm in load balanced environment, since you will probably have to provide the same configuration on all web service machines). This may not be an acceptable solution on many production configurations especially in public networks (due to possible DoS threat) - I'm not sure how this affects other client APIs (like JS). This is rather a walkaround.<br /><br />Happy sharepointing!