---
layout: post
title: Replace attachment in document library without changing version number
date: '2012-03-06T01:03:00.000+01:00'
author: Marek Mierzwa
tags:
- attachment
- document library
modified_time: '2012-03-06T13:20:06.963+01:00'
blogger_id: tag:blogger.com,1999:blog-2283486810269355053.post-2358495401711229210
blogger_orig_url: http://byteloom.blogspot.com/2012/03/replace-attachment-in-document-library.html
---

Lately I was looking  for some example on how to replace the attachment in document library (SP2010) without changing the version number but without any results. If you've faced the same problem here is the solution:  <a name='more'></a> <pre class="brush: csharp"><br />SPWeb webSite = SPContext.Current.Web;<br />SPDocumentLibrary library = webSite.Lists[libraryName] as SPDocumentLibrary;<br /><br />if (library == null)<br />{<br />    throw new SPException("There is no document lirbary named " + libraryName);<br />}<br /><br />using (MemoryStream docStream = new MemoryStream())<br />{<br />    BinaryWriter docWriter = new BinaryWriter(docStream);<br />    docWriter.Write(yourContentString);<br /><br />    SPFile file = find(library, fileName);<br /><br />    if (file == null)<br />    {<br />        throw new SPException("File " + fileName + " not found");<br />    }<br /><br />    file.CheckOut();<br />    file.SaveBinary(docStream);<br />    file.CheckIn(string.Empty, SPCheckinType.OverwriteCheckIn);<br /><br />    docWriter.Close();<br />}<br /></pre> Utility method find() - find a file by name - is defined as follow:  <pre class="brush: csharp"><br />private static SPFile find(SPDocumentLibrary library, string fileName)<br />{<br />    SPFileCollection files = library.RootFolder.Files;<br />    for (int fileIdx = 0; fileIdx < files.Count; fileIdx++)<br />    {<br />        if (files[fileIdx].Name == fileName)<br />        {<br />            return files[fileIdx];<br />        }<br />    }<br /><br />    return null;<br />}<br /></pre> Im assuming that the file has already been uploaded to document library. The most important parts are: <ol><li>Retrieve reference to the file (<a href="http://msdn.microsoft.com/en-us/library/ms461145.aspx">SPFile</a>). I've done this by iterating through all files in root folder of document library, but actualy you can do this however you want </li><li>Check out the file (<a href="http://msdn.microsoft.com/en-us/library/ms454425.aspx">SPFile.CheckOut()</a>) <pre class="brush: csharp"><br />file.CheckOut();<br /></pre></li><li>Replace the attachment.Convinient method for doing this is <a href="http://msdn.microsoft.com/en-us/library/ms465421.aspx">SPFile.SaveBinary</a> which takes stream with content as an argument (I've used MemoryStream to read the content from a text box in my PoC, but you can pass the FileStream or something else) <pre class="brush: csharp"><br />file.SaveBinary(docStream);<br /></pre></li><li>Check in the file (<a href="http://msdn.microsoft.com/en-us/library/ms412209.aspx">SPFile.CheckIn()</a>). In order to save the attachment without incrasing the version number you must specify <a href="http://msdn.microsoft.com/en-us/library/microsoft.sharepoint.spcheckintype.aspx">SPCheckinType</a> as OverwriteCheckIn <pre class="brush: csharp"><br />file.CheckIn(string.Empty, SPCheckinType.OverwriteCheckIn);<br /></pre></li></ol> The alternative method is by using <a href="http://msdn.microsoft.com/en-us/library/ms481195.aspx">SPListItem.SystemUpdate</a> with incrementListItemVersion set false. SystemUpdate will not change item modification date and modified by fields values. In this approach you will work with document library item instead of file. <br/> Additionally if you want to change the attachment name, you can do this by with <a href="http://msdn.microsoft.com/en-us/library/ms438892.aspx">SPFile.MoveTo</a> method (after changing the original attachment content):  <pre class="brush:csharp"><br />if (!string.IsNullOrEmpty(newFileName))<br />{<br />    string newPath = string.Format("{0}/{1}", file.ParentFolder.Url, newFileName);<br />    file.MoveTo(newPath, true);<br />}<br /></pre> Happy sharepointing.  <br/><br/><b>The VS solution with code samples for this article is available on GoogleCode SVN: <a href="http://byteloom-codesamples.googlecode.com/svn/trunk/ReplaceAttachement/" target="_blank">http://byteloom-codesamples.googlecode.com/svn/trunk/ReplaceAttachement/</a></b>