---
layout: post
title: SharePoint Taxonomies - Struggling with dupplicated default labels
date: '2012-09-28T09:47:00.001+02:00'
author: Marek Mierzwa
tags:
- term
- taxonomy
- StoragePoint
modified_time: '2012-11-11T22:13:03.239+01:00'
blogger_id: tag:blogger.com,1999:blog-2283486810269355053.post-7343601350174608200
blogger_orig_url: http://byteloom.blogspot.com/2012/09/sharepoint-taxonomies-struggling-with.html
---

If you have ever had to load large number of data into SharePoint MMD service or build taxonomies automatically you have likely encountered the following problem:<br /><br /><pre class="brush: text">Microsoft.SharePoint.Taxonomy.TermStoreOperationException: There is already a term with the same default label and parent term.<br /></pre><a name='more'></a><br /><pre class="brush: text">at Microsoft.SharePoint.Taxonomy.MetadataWebServiceApplicationProxy.&lt;&gt;c__DisplayClass2c.b__2b()<br />at Microsoft.Office.Server.Security.SecurityContext.RunAsProcess(CodeToRunElevated secureCode)<br />at Microsoft.SharePoint.Taxonomy.MetadataWebServiceApplicationProxy.&lt;&gt;c__DisplayClass2c.b__2a()<br />at Microsoft.Office.Server.Utilities.MonitoredScopeWrapper.RunWithMonitoredScope(Action code)<br />at Microsoft.SharePoint.Taxonomy.MetadataWebServiceApplicationProxy.RunOnChannel(CodeToRun codeToRun, Double operationTimeoutFactor)<br />at Microsoft.SharePoint.Taxonomy.MetadataWebServiceApplicationProxy.RunOnChannel(CodeToRun codeToRun)<br />at Microsoft.SharePoint.Taxonomy.Internal.TaxonomyProxyAccess.Write(String data)<br />at Microsoft.SharePoint.Taxonomy.Internal.DataAccessManager.Write(String data)<br />at Microsoft.SharePoint.Taxonomy.Internal.Sandbox.CommitSandbox()<br />at Microsoft.SharePoint.Taxonomy.TermStore.CommitAll()<br /></pre><br />Not very informative stacktrace as you see... First, this happens during the commit, not on creation of new term. Second, there is no information about the conflicting labels. (This is because the validation is done in SQL after building the whole changed structure, which you can check in ULS logs). This error could be quite frustrating, which I've experienced myself (I lost three days on this when I was implementing full synchronization of large tree structure with SP taxonomies). I will try to give some hints all of those which are struggling with duplicated labels.<br /><br /><h4>Remember about default label conversions</h4><br />As I wrote in my previous post - <a href="{{ site.baseurl }}{% post_url 2012-09-20-sharepoint-taxonomies-labels-with %}">"SharePoint Taxonomies - Labels with forbiden characters"</a>, SharePoint performs some <a href="http://msdn.microsoft.com/en-us/library/microsoft.sharepoint.taxonomy.term.name.aspx" target="_blank">transformations on label strings</a>: trim, replacing consecutive spaces into one and ampersand with its wider Unicode equivalent (\uFF06). <br /><br />The result of above is that label <tt>"  black   duck & goose "</tt> and <tt>"black duck &#xFF06; goose"</tt> will be treated as the same label string.<br /><br />If you decide to replace the characters forbidden in labels (;"<>|&tab) with some others you will have to keep in mind these transformation to.<br /><br /><h4>Labels are compared case invariant</h4><br />This means that label <tt>"BlAcK DuCK"</tt> will be treated as the same string as label <tt>"black duck"</tt>.<br /><br /><h4>Label changed after creation before commit is not really changed...</h4><br />This was my case (3 days of digging...). Consider the following code:<br /><br /><pre class="brush: csharp">//parent (TermSetItem) and termStore is defined before this snippet<br /><br />//...<br /><br />var term1Label = "black duck";<br />var term1 = parent.CreateTerm(term1Label, 1033);<br /><br />var term2Label = "black duck";<br />var term2 = parent.CreateTerm(term2Label, 1033);<br /><br />term2.Name = "white goose";<br /><br />//...<br /><br />termStore.CommitAll();<br /></pre><br />If you think this code will run without any problem you are wrong. As I did.<br />You must ensure the label uniqueness between sibling nodes in the time when they are created. Of course this fact is not documented in API on MSDN...<br /><br />As some used to say - there is a thin line between bug and feature ;-)<br /><img style="margin-left: auto; margin-right: auto; width: 20em;" src="http://www.designer-daily.com/wp-content/uploads/2009/06/bug-feature.jpg"></img><br /><br /><h4>How to hunt the vampire down?</h4><br />The last tip I can give you is a little piece of code you can run just before the commit in order to find the problematic labels:<br /><br /><pre class="brush: csharp">//this will give you all terms in the group (you can narrow the scope, i.e. to particular term set, if you like<br />var terms = termGroup.TermSets.SelectMany(termSet => termSet.GetAllTerms());<br /><br />//this will actually return the terms with duplicated labels (for default LCID) grouped by parent-label pair<br />var duplicates = terms.<br />    GroupBy(term => string.Format("{0}:{1}", getParentGuid(term), term.Name.ToLowerInvariant())).<br />    Where(group => group.Count() > 1).<br />    SelectMany(group => group).<br />    ToList();<br /><br />//now you can do with them whatever you like, i.e. write them out to the file:<br />var termsStr = new StringBuilder();<br />termStr.Append("Term GUID;Term default label;Parent GUID");<br />foreach (var term in duplicates)<br />{<br />    termsStr.AppendFormat("{0};\"{1}\";{2}\n", term.Id, term.Name, getParentGuid(term));<br />}<br />File.AppendAllText(@"c:\duplicatedTerms.txt", termsStr.ToString(), new UTF32Encoding());<br /></pre><br /><pre class="brush: csharp">string getParentGuid(Term term)<br />{<br />    return term.Parent != null ? term.Parent.Id.ToString() : term.TermSet.Id.ToString();<br />}<br /></pre><br />Unfortunately this won't help if you change the label after creation like mentioned above.<br /><br />I hope this little guideline will save you some time.